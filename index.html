<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Rollout Studio</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
:root{--bg:#FAFAFA;--surface:#fff;--border:#e5e5e5;--border-lt:#f0f0f0;--t1:#111;--t2:#666;--t3:#aaa;--r:12px;--rs:8px}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;display:flex;flex-direction:column;-webkit-font-smoothing:antialiased}

.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:52px;display:flex;align-items:center;gap:28px;position:sticky;top:0;z-index:20}
.logo{font-weight:600;font-size:.88em;display:flex;align-items:center;gap:6px;flex-shrink:0}
.stepper{display:flex;flex:1;max-width:520px}
.st{flex:1;display:flex;flex-direction:column;cursor:default}
.st.clickable{cursor:pointer}
.st-top{display:flex;align-items:center;width:100%}
.st-circle{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:2px solid var(--border);background:var(--border-lt);position:relative;z-index:2;transition:all .25s}
.st-circle .dot{width:7px;height:7px;border-radius:50%;background:#ccc;transition:background .2s}
.st.active .st-circle{border-color:var(--t1);background:var(--surface)}
.st.active .st-circle .dot{background:var(--t1)}
.st.done .st-circle{border-color:var(--t1);background:var(--t1)}
.st.done .st-circle .dot{display:none}
.st.done .st-circle::after{content:'✓';color:#fff;font-size:.65em;font-weight:700}
.st-line{flex:1;height:2px;background:var(--border);margin:0 5px;transition:background .25s}
.st.done .st-line{background:var(--t1)}
.st:last-child .st-line{display:none}
.st-label{font-size:.72em;font-weight:500;color:var(--t3);margin-top:6px;padding-left:2px}
.st.active .st-label{color:var(--t1);font-weight:600}
.st.done .st-label{color:var(--t2)}

.main{flex:1;max-width:1200px;width:100%;margin:0 auto;padding:28px 24px 96px}
.page{display:none;flex-direction:column;gap:20px;animation:fadeIn .2s ease}
.page.active{display:flex}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:1.4em;font-weight:600;letter-spacing:-.02em}
.card{background:var(--surface);border-radius:var(--r);border:1px solid var(--border);overflow:hidden}
.card-pad{padding:20px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border-radius:var(--rs);font-size:.82em;font-weight:500;cursor:pointer;border:none;transition:all .12s;font-family:inherit}
.btn:disabled{opacity:.35;cursor:default;pointer-events:none}
.btn-dark{background:var(--t1);color:#fff}.btn-dark:hover{background:#333}
.btn-outline{background:var(--surface);color:var(--t2);border:1px solid var(--border)}.btn-outline:hover{background:#f8f8f8}
.btn-ghost{background:transparent;color:var(--t3);padding:7px 10px}.btn-ghost:hover{background:var(--border-lt);color:var(--t2)}
.btn-sm{padding:5px 10px;font-size:.76em}
.btn-icon{padding:4px;width:26px;height:26px;justify-content:center}
.btn-danger{background:transparent;color:#d88;border:1px solid #e8e8e8}.btn-danger:hover{background:#fff5f5}

.bottombar{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:10px 24px;display:flex;justify-content:space-between;align-items:center;z-index:10}
.bb-right{display:flex;align-items:center;gap:10px}
.bb-hint{font-size:.76em;color:var(--t3)}

.dropzone{border:1.5px dashed var(--border);border-radius:var(--r);padding:52px 24px;text-align:center;cursor:pointer;transition:all .2s}
.dropzone:hover,.dropzone.over{border-color:#aaa;background:#fdfdfd}
.dz-icon{font-size:2em;margin-bottom:8px;opacity:.4}
.dz-title{font-size:.88em;font-weight:500;color:var(--t2)}
.dz-sub{font-size:.76em;color:var(--t3);margin-top:4px}
.thumb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:6px;margin-top:12px}
.thumb{position:relative;border-radius:var(--rs);aspect-ratio:4/3;overflow:hidden;border:1px solid var(--border)}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb .rm{position:absolute;top:3px;right:3px;width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,.4);color:#fff;border:none;cursor:pointer;font-size:9px;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s}
.thumb:hover .rm{opacity:1}
.thumb .num{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.3);color:#fff;font-size:10px;text-align:center;padding:1px 0}
.count{font-size:.76em;color:var(--t3);margin-top:6px}

.rim-grid{display:flex;gap:10px;overflow-x:auto;padding:4px 0}
.rim-card{border-radius:var(--r);border:1px solid var(--border);overflow:hidden;background:var(--surface);min-width:280px;max-width:420px;flex-shrink:0}
.rim-card canvas{display:block;width:100%;touch-action:none;cursor:default}
.rim-foot{padding:6px 10px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border-lt)}
.rim-foot span{font-size:.7em;color:var(--t3)}
.legend{display:flex;gap:12px;font-size:.72em;color:var(--t3);align-items:center}
.legend-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:3px}

.strip-scroll{display:flex;gap:8px;overflow-x:auto;padding:2px 0}
.strip-card{min-width:180px;border-radius:var(--rs);border:1px solid var(--border);overflow:hidden;flex-shrink:0;background:var(--surface)}
.strip-card canvas{display:block;width:100%;touch-action:none;cursor:ew-resize}
.strip-foot{padding:5px 8px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border-lt)}
.strip-foot span{font-size:10px;color:var(--t3)}
.strip-foot .acts{display:flex;gap:2px}
.slider-row{display:flex;align-items:center;gap:12px;font-size:.8em;color:var(--t2)}
.slider-row label{font-weight:500;font-size:.72em;text-transform:uppercase;letter-spacing:.03em;color:var(--t3);width:50px}
.slider-row input[type=range]{flex:1;max-width:160px;accent-color:var(--t1)}
.slider-row .val{font-weight:600;color:var(--t1);width:32px;text-align:right}
.preview-bar{border-radius:var(--rs);border:1px solid var(--border);background:var(--border-lt);padding:8px;overflow-x:auto;margin-top:12px}
.preview-bar canvas{display:block;max-width:100%;border-radius:4px}
.meta{font-size:.72em;color:var(--t3);margin-top:4px}
.chk-row{display:flex;align-items:center;gap:8px;font-size:.8em;color:var(--t2);margin-top:4px}
.chk-row input{accent-color:var(--t1)}

.stitch-center{display:flex;flex-direction:column;align-items:center;gap:20px;padding:56px 16px;text-align:center}
.spinner{width:36px;height:36px;border:2.5px solid var(--border);border-top-color:var(--t1);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.pbar{width:280px;height:3px;background:var(--border-lt);border-radius:2px;overflow:hidden}
.pbar-fill{height:100%;background:var(--t1);border-radius:2px;transition:width .3s}
.p-steps{display:flex;flex-direction:column;gap:6px;width:280px;margin-top:4px}
.p-step{display:flex;align-items:center;gap:8px;font-size:.8em;color:var(--t3);transition:color .2s}
.p-step.active{color:var(--t1);font-weight:500}
.p-step.done{color:#4caf50}
.p-dot{width:5px;height:5px;border-radius:50%;background:var(--border);flex-shrink:0}
.p-step.active .p-dot{background:var(--t1)}
.p-step.done .p-dot{background:#4caf50}
.check-circle{width:36px;height:36px;border-radius:50%;background:var(--t1);display:flex;align-items:center;justify-content:center;color:#fff;font-size:.8em;font-weight:700}
.stitch-log{font-family:monospace;font-size:.72em;color:var(--t3);background:var(--border-lt);border:1px solid var(--border);border-radius:var(--rs);padding:10px;margin-top:12px;max-height:200px;overflow-y:auto;white-space:pre-wrap;line-height:1.5;display:none}

.section{margin-bottom:16px}
.sec-head{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.sec-label{font-size:.7em;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.04em}
.opt-badge{font-size:.68em;color:#ccc;background:var(--border-lt);padding:1px 6px;border-radius:4px}
.toolbar{display:flex;gap:4px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
.canvas-wrap{width:100%;border-radius:var(--rs);background:var(--border-lt);border:1px solid var(--border);position:relative;overflow:hidden;padding:4px}
.canvas-wrap canvas{display:block;width:100%;border-radius:4px;touch-action:none}
.export-row{display:flex;gap:8px;flex-wrap:wrap}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
.modal-overlay.open{display:flex}
.modal-card{width:min(420px,100%);background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:0 16px 48px rgba(0,0,0,.2);padding:20px}
.modal-title{font-weight:600;color:var(--t1);margin-bottom:6px}
.modal-body{color:var(--t2);font-size:.88em;line-height:1.4;margin-bottom:16px}
.modal-actions{display:flex;justify-content:flex-end;gap:8px}
</style>
</head>
<body>

<div class="topbar">
  <div class="logo">Rollout Studio</div>
  <div class="stepper" id="stepper"></div>
</div>

<div class="main">
  <div class="page active" id="p0"></div>
  <div class="page" id="p1"></div>
  <div class="page" id="p2"></div>
  <div class="page" id="p3"></div>
  <div class="page" id="p4"></div>
</div>

<div class="bottombar" id="bottombar">
  <div><button class="btn btn-ghost" id="btnBack" style="visibility:hidden">← Back</button></div>
  <div class="bb-right">
    <span class="bb-hint" id="hint"></span>
    <button class="btn btn-dark" id="btnNext">Map Rims →</button>
  </div>
</div>

<input type="file" id="fi" multiple accept="image/*,.json" style="display:none">

<script>
"use strict";

/* ═══ GLOBALS ═══ */
var STEPS=["Upload","Map","Adjust","Stitch","Refine"];
var NEXT=["Map Rims →","Adjust Strips →","Start Stitching","",""];
var LZOOM=2,LR=40,HR=5;
var HF='https://noahhowa-image-stitch-fork.hf.space';
var imgs=[],stripCache=[],rCanvas=null,rawHFCanvas=null;
var cur=0,mx=0,feather=12;
/* Refine state: horizontal + vertical lines, mode toggle */
var topLine=[],botLine=[],leftLine=[],rightLine=[];
var refineMode='h',activeLine='top',dragIdx=-1,rectSc=1;
var originalHFCanvas=null;
var stitchRunning=false,stitchAbort=null;

function med(a){var s=a.slice().sort(function(x,y){return x-y;});return s[s.length>>1];}

/* ═══ MODAL ═══ */
function confirmDestructive(opts){
  var ov=document.getElementById('dModal');
  if(!ov){
    ov=document.createElement('div');ov.id='dModal';ov.className='modal-overlay';
    ov.innerHTML='<div class="modal-card"><div class="modal-title" id="dmT"></div><div class="modal-body" id="dmB"></div><div class="modal-actions"><button class="btn btn-ghost" id="dmC">Cancel</button><button class="btn btn-dark" id="dmOk">Continue</button></div></div>';
    document.body.appendChild(ov);
  }
  document.getElementById('dmT').textContent=opts.title||'Are you sure?';
  document.getElementById('dmB').textContent=opts.body||'';
  document.getElementById('dmOk').textContent=opts.confirmText||'Continue';
  function close(){ov.classList.remove('open');}
  document.getElementById('dmC').onclick=close;
  document.getElementById('dmOk').onclick=function(){close();if(opts.onConfirm)opts.onConfirm();};
  ov.onclick=function(e){if(e.target===ov)close();};
  ov.classList.add('open');
}

/* ═══ STEPPER + NAV ═══ */
function renderStepper(){
  var el=document.getElementById('stepper');el.innerHTML='';
  STEPS.forEach(function(s,i){
    var done=i<cur,active=i===cur,locked=i>mx;
    var d=document.createElement('div');
    d.className='st'+(done?' done':'')+(active?' active':'')+((!locked&&i!==cur)?' clickable':'');
    d.innerHTML='<div class="st-top"><div class="st-circle"><div class="dot"></div></div>'+(i<STEPS.length-1?'<div class="st-line"></div>':'')+'</div><div class="st-label">'+s+'</div>';
    if(!locked&&i!==cur)d.onclick=function(){go(i);};
    el.appendChild(d);
  });
}

function go(n){
  if(n<0||n>4||stitchRunning)return;
  cur=n;if(n>mx)mx=n;
  document.querySelectorAll('.page').forEach(function(p,i){p.classList.toggle('active',i===n);});
  renderStepper();
  var back=document.getElementById('btnBack');
  back.style.visibility=(n>0&&n!==3)?'visible':'hidden';
  var nb=document.getElementById('btnNext'),hint=document.getElementById('hint');
  nb.textContent=NEXT[n]||'';nb.disabled=false;nb.style.display=(n>=3)?'none':'';
  hint.textContent='';
  document.getElementById('bottombar').style.display=(n===4)?'none':'flex';
  if(n===0){renderUpload();nb.disabled=imgs.length<2;hint.textContent=(imgs.length>0&&imgs.length<2)?'Add at least 2 photos':'';}
  if(n===1)renderMap();
  if(n===2)renderAdjust();
  if(n===3)runStitch();
  if(n===4)renderRefine();
}

document.getElementById('btnNext').onclick=function(){go(cur+1);};
document.getElementById('btnBack').onclick=function(){go(cur-1);};

/* ═══ IMAGE PROCESSING ═══ */
function getPx(c){return c.getContext('2d').getImageData(0,0,c.width,c.height).data;}

function detectBounds(cv){
  var W=cv.width,H=cv.height,px=getPx(cv);
  var pts=[[0,0],[W-1,0],[0,H-1],[W-1,H-1],[W>>1,0],[W>>1,H-1],[0,H>>1],[W-1,H>>1]];
  var s=pts.map(function(p){var i=(p[1]*W+p[0])*4;return[px[i],px[i+1],px[i+2]];});
  var bR=med(s.map(function(v){return v[0];})),bG=med(s.map(function(v){return v[1];})),bB=med(s.map(function(v){return v[2];}));
  function fg(x,y){if(x<0||y<0||x>=W||y>=H)return false;var i=(y*W+x)*4;return Math.abs(px[i]-bR)+Math.abs(px[i+1]-bG)+Math.abs(px[i+2]-bB)>35;}
  var xL=W,xR=0,yT=-1,yB=-1;
  for(var y=0;y<H;y++){var l=-1,rr=-1;for(var x=0;x<W;x++){if(fg(x,y)){if(l<0)l=x;rr=x;}}if(l>=0&&(rr-l)>W*0.05){if(yT<0)yT=y;yB=y;if(l<xL)xL=l;if(rr>xR)xR=rr;}}
  if(yT<0){yT=5;yB=H-5;xL=Math.round(W*0.1);xR=Math.round(W*0.9);}
  return{cx:(xL+xR)/2,r:(xR-xL)/2,yTop:Math.max(0,yT-3),yBot:Math.min(H-1,yB+3),xLeft:Math.max(0,xL-3),xRight:Math.min(W-1,xR+3)};
}

function isRed(r,g,b){return r>90&&r>g*1.4&&r>b*1.4;}
function rimY(cv,b,x,w){
  var px=getPx(cv),W=cv.width,sp=b.yBot-b.yTop;x=Math.max(0,Math.min(W-1,Math.round(x)));
  if(w==='top'){var ir=false;for(var y=b.yTop;y<b.yTop+sp*0.5;y++){var i=(y*W+x)*4;if(isRed(px[i],px[i+1],px[i+2]))ir=true;else if(ir)return y;}return b.yTop+sp*0.12;}
  else{var ir2=false;for(var y2=b.yBot;y2>b.yBot-sp*0.5;y2--){var i2=(y2*W+x)*4;if(isRed(px[i2],px[i2+1],px[i2+2]))ir2=true;else if(ir2)return y2;}return b.yBot-sp*0.12;}
}
function initH(cv,b,w){
  var pts=[b.xLeft,b.cx,b.xRight].map(function(x){return{x:x,y:rimY(cv,b,x,w)};});
  var span=pts[2].x-pts[0].x;
  pts[0].cp={x:pts[0].x+span*0.25,y:pts[0].y};
  pts[2].cp={x:pts[2].x-span*0.25,y:pts[2].y};
  return pts;
}

/* Bezier */
function cubicBez(p0,p1,p2,p3,t){var u=1-t;return{x:u*u*u*p0.x+3*u*u*t*p1.x+3*u*t*t*p2.x+t*t*t*p3.x,y:u*u*u*p0.y+3*u*u*t*p1.y+3*u*t*t*p2.y+t*t*t*p3.y};}
function evalRimCurve(h,x){
  var cp0=h[0].cp||{x:h[0].x+(h[1].x-h[0].x)*0.33,y:h[0].y};
  var cp2=h[2].cp||{x:h[2].x-(h[2].x-h[1].x)*0.33,y:h[2].y};
  var midCpL={x:h[1].x-(h[1].x-h[0].x)*0.33,y:h[1].y};
  var midCpR={x:h[1].x+(h[2].x-h[1].x)*0.33,y:h[1].y};
  if(x<=h[0].x)return h[0].y;
  if(x>=h[2].x)return h[2].y;
  if(x<=h[1].x){
    var tR=h[1].x-h[0].x;if(tR<1)return h[0].y;
    var t=(x-h[0].x)/tR;
    for(var it=0;it<5;it++){var pt=cubicBez(h[0],cp0,midCpL,h[1],t);var dx=3*(1-t)*(1-t)*(cp0.x-h[0].x)+6*(1-t)*t*(midCpL.x-cp0.x)+3*t*t*(h[1].x-midCpL.x);if(Math.abs(dx)>0.01)t-=(pt.x-x)/dx;t=Math.max(0,Math.min(1,t));}
    return cubicBez(h[0],cp0,midCpL,h[1],t).y;
  }else{
    var tR=h[2].x-h[1].x;if(tR<1)return h[1].y;
    var t=(x-h[1].x)/tR;
    for(var it=0;it<5;it++){var pt=cubicBez(h[1],midCpR,cp2,h[2],t);var dx=3*(1-t)*(1-t)*(midCpR.x-h[1].x)+6*(1-t)*t*(cp2.x-midCpR.x)+3*t*t*(h[2].x-cp2.x);if(Math.abs(dx)>0.01)t-=(pt.x-x)/dx;t=Math.max(0,Math.min(1,t));}
    return cubicBez(h[1],midCpR,cp2,h[2],t).y;
  }
}

/* Snap to edge */
function _snap_buildLum(cv){var ctx=cv.getContext('2d'),W=cv.width,H=cv.height,d=ctx.getImageData(0,0,W,H).data,lum=new Float32Array(W*H);for(var i=0,px=0;i<lum.length;i++,px+=4)lum[i]=0.299*d[px]+0.587*d[px+1]+0.114*d[px+2];return{lum:lum,W:W,H:H};}
function _snap_blur1D(src,W,H,r){if(r<=0)return src;var tmp=new Float32Array(W*H),out=new Float32Array(W*H);for(var y=0;y<H;y++){var base=y*W;for(var x=0;x<W;x++){var s=0,n=0;for(var dx=-r;dx<=r;dx++){var xx=x+dx;if(xx>=0&&xx<W){s+=src[base+xx];n++;}}tmp[base+x]=s/n;}}for(var x=0;x<W;x++){for(var y=0;y<H;y++){var s=0,n=0;for(var dy=-r;dy<=r;dy++){var yy=y+dy;if(yy>=0&&yy<H){s+=tmp[yy*W+x];n++;}}out[y*W+x]=s/n;}}return out;}
function _snap_buildVertGrad(lum,W,H){var g=new Float32Array(W*H);for(var y=1;y<H-1;y++){var y0=(y-1)*W,y1=y*W,y2=(y+1)*W;for(var x=1;x<W-1;x++){var dY=(lum[y2+x-1]+2*lum[y2+x]+lum[y2+x+1])-(lum[y0+x-1]+2*lum[y0+x]+lum[y0+x+1]);g[y1+x]=Math.abs(dY);}}return g;}
function _snap_buildDoG(lum,W,H,r1,r2){var b1=_snap_blur1D(lum,W,H,r1),b2=_snap_blur1D(lum,W,H,r2),dog=new Float32Array(W*H);for(var i=0;i<dog.length;i++)dog[i]=Math.abs(b1[i]-b2[i]);return dog;}
function _snap_getEdgeCache(im,mode){mode=mode||3;if(!im._ec)im._ec={};var k='m'+mode,W=im.cv.width,H=im.cv.height;if(im._ec[k]&&im._ec[k].w===W)return im._ec[k];var r=_snap_buildLum(im.cv),lum=r.lum,lumB=_snap_blur1D(lum,W,H,2);var vg=_snap_buildVertGrad(lumB,W,H),dog=_snap_buildDoG(lumB,W,H,1,4),em=new Float32Array(W*H);for(var i=0;i<em.length;i++)em[i]=0.65*vg[i]+0.35*dog[i];var res={grad:em,w:W,h:H};im._ec[k]=res;return res;}
function _snap_fitEllipse(xs,ys,xC,a,sgn){var sT=0,sY=0,sTT=0,sTY=0,n=xs.length;for(var i=0;i<n;i++){var u=(xs[i]-xC)/a,t=(u*u<=1)?Math.sqrt(1-u*u):0;sT+=t;sY+=ys[i];sTT+=t*t;sTY+=t*ys[i];}var mT=sT/n,mY=sY/n,vT=Math.max(1e-6,sTT-n*mT*mT);return{yC:mY-(sTY-n*mT*mY)/vT*mT,k:(sTY-n*mT*mY)/vT*sgn};}
function snapRimToEdge(im,w,opts){
  opts=opts||{};var b=im.b,edge=_snap_getEdgeCache(im,3),grad=edge.grad,W=edge.w,H=edge.h;
  var sR=opts.searchR||22,sP=opts.smoothPenalty||2.8,pW=opts.priorW||0.55;
  var h=(w==='top')?b.topH:b.botH,xL=Math.max(2,Math.round(h[0].x)),xR=Math.min(W-3,Math.round(h[2].x));
  if(xR<=xL+5)return;
  var xs=[],ys=[];for(var x=xL;x<=xR;x+=3){xs.push(x);ys.push(evalRimCurve(h,x));}
  var xC=(xL+xR)/2,a=(xR-xL)/2,sgn=(w==='top')?-1:1,prior=_snap_fitEllipse(xs,ys,xC,a,sgn);
  var cols=[];for(var x=xL;x<=xR;x++)cols.push(x);var XN=cols.length;
  var bMin=new Int16Array(XN),bMax=new Int16Array(XN),YN=0;
  for(var i=0;i<XN;i++){var y0=evalRimCurve(h,cols[i]);bMin[i]=Math.max(2,Math.round(y0-sR));bMax[i]=Math.min(H-3,Math.round(y0+sR));if(bMax[i]<bMin[i]){bMin[i]=Math.max(2,Math.round(y0));bMax[i]=bMin[i];}YN=Math.max(YN,bMax[i]-bMin[i]+1);}
  if(YN<2)return;
  var dp=new Float32Array(XN*YN),back=new Int16Array(XN*YN),yB=new Int16Array(XN);
  yB[0]=bMin[0];var yN0=bMax[0]-bMin[0]+1;
  for(var yi=0;yi<YN;yi++){dp[yi]=-1e30;back[yi]=-1;}
  for(var yi=0;yi<yN0;yi++){var y=bMin[0]+yi,u=(cols[0]-xC)/a,t=(u*u<=1)?Math.sqrt(1-u*u):0,yE=prior.yC+prior.k*t;dp[yi]=grad[y*W+cols[0]]-pW*Math.abs(y-yE);}
  for(var xi=1;xi<XN;xi++){yB[xi]=bMin[xi];var yNi=bMax[xi]-bMin[xi]+1;for(var yi=0;yi<YN;yi++){dp[xi*YN+yi]=-1e30;}var x=cols[xi],u=(x-xC)/a,t=(u*u<=1)?Math.sqrt(1-u*u):0,yE=prior.yC+prior.k*t,pMin=yB[xi-1],pN=bMax[xi-1]-bMin[xi-1]+1;
    for(var yi=0;yi<yNi;yi++){var y=bMin[xi]+yi,best=-1e30,bp=0;for(var py=0;py<pN;py++){var pY=pMin+py;if(Math.abs(pY-y)>7)continue;var c=dp[(xi-1)*YN+py]-sP*Math.abs(y-pY);if(c>best){best=c;bp=py;}}dp[xi*YN+yi]=best+grad[y*W+x]-pW*Math.abs(y-yE);back[xi*YN+yi]=bp;}}
  var eN=bMax[XN-1]-bMin[XN-1]+1,eYi=0,eB=-1e30;for(var yi=0;yi<eN;yi++){var v=dp[(XN-1)*YN+yi];if(v>eB){eB=v;eYi=yi;}}
  var seam=new Array(XN),c=eYi;for(var xi=XN-1;xi>=0;xi--){seam[xi]=yB[xi]+c;c=back[xi*YN+c]||0;}
  function at(xq){if(xq<=cols[0])return seam[0];if(xq>=cols[XN-1])return seam[XN-1];return seam[Math.max(0,Math.min(XN-1,Math.round(xq-cols[0])))];}
  h[0].y=at(h[0].x);h[1].y=at(h[1].x);h[2].y=at(h[2].x);
  if(h[0].cp)h[0].cp.y=at(h[0].cp.x);if(h[2].cp)h[2].cp.y=at(h[2].cp.x);
}

function evP(a,x){return a[0]*x*x+a[1]*x+a[2];}
function hGeom(b){var xLt=b.topH[0].x,xRt=b.topH[2].x,xLb=b.botH[0].x,xRb=b.botH[2].x;return{cxt:(xLt+xRt)/2,rt:(xRt-xLt)/2,cxb:(xLb+xRb)/2,rb:(xRb-xLb)/2,cx:(xLt+xRt+xLb+xRb)/4,r:((xRt-xLt)+(xRb-xLb))/4};}
function bil(d,W,H,x,y){var x0=x|0,y0=y|0,fx=x-x0,fy=y-y0;if(x0<0||y0<0||x0>=W-1||y0>=H-1)return null;var i00=(y0*W+x0)*4,i10=i00+4,i01=i00+W*4,i11=i01+4;return[d[i00]*(1-fx)*(1-fy)+d[i10]*fx*(1-fy)+d[i01]*(1-fx)*fy+d[i11]*fx*fy,d[i00+1]*(1-fx)*(1-fy)+d[i10+1]*fx*(1-fy)+d[i01+1]*(1-fx)*fy+d[i11+1]*fx*fy,d[i00+2]*(1-fx)*(1-fy)+d[i10+2]*fx*(1-fy)+d[i01+2]*(1-fx)*fy+d[i11+2]*fx*fy];}

function unwarp(cv,b,tR){
  var g=hGeom(b),rR=tR||g.r,sc=rR/g.r;
  var oW=Math.max(10,Math.round(Math.PI*rR));
  var midTopY=evalRimCurve(b.topH,g.cx),midBotY=evalRimCurve(b.botH,g.cx);
  var oH=Math.max(10,Math.round((midBotY-midTopY)*sc));
  var out=document.createElement('canvas');out.width=oW;out.height=oH;
  var oC=out.getContext('2d'),oI=oC.createImageData(oW,oH),src=cv.getContext('2d').getImageData(0,0,cv.width,cv.height),W=cv.width,H=cv.height;
  for(var oy=0;oy<oH;oy++){var ty=oy/(oH-1||1),cx=g.cxt+ty*(g.cxb-g.cxt),r=g.rt+ty*(g.rb-g.rt);for(var ox=0;ox<oW;ox++){var th=(ox/(oW-1||1))*Math.PI-Math.PI/2,sx=cx+r*Math.sin(th);
    var topY=evalRimCurve(b.topH,sx),botY=evalRimCurve(b.botH,sx);
    var sy=topY+ty*(botY-topY);
    var c=bil(src.data,W,H,sx,sy);if(c){var ii=(oy*oW+ox)*4;oI.data[ii]=c[0];oI.data[ii+1]=c[1];oI.data[ii+2]=c[2];oI.data[ii+3]=255;}}}
  oC.putImageData(oI,0,0);return out;
}

function compVig(cv){
  var ctx=cv.getContext('2d'),W=cv.width,H=cv.height,im=ctx.getImageData(0,0,W,H),d=im.data;
  var cB=new Float64Array(W);for(var x=0;x<W;x++){var s=0;for(var y=0;y<H;y++){var i=(y*W+x)*4;s+=.299*d[i]+.587*d[i+1]+.114*d[i+2];}cB[x]=s/H;}
  var k=Math.round(W*.18)|1,hf=k>>1,sm=new Float64Array(W);for(var x=0;x<W;x++){var s=0,n=0;for(var j=-hf;j<=hf;j++){var xx=x+j;if(xx>=0&&xx<W){s+=cB[xx];n++;}}sm[x]=s/n;}
  var c0=Math.round(W*.25),c1=Math.round(W*.75),tg=0,tn=0;for(var x=c0;x<c1;x++){tg+=sm[x];tn++;}tg/=tn;if(tg<5)return;
  for(var x=0;x<W;x++){var gn=sm[x]>5?tg/sm[x]:1;gn=Math.max(.6,Math.min(2,gn));for(var y=0;y<H;y++){var i=(y*W+x)*4;d[i]=Math.min(255,d[i]*gn+.5|0);d[i+1]=Math.min(255,d[i+1]*gn+.5|0);d[i+2]=Math.min(255,d[i+2]*gn+.5|0);}}
  ctx.putImageData(im,0,0);
}

function cropStrip(cv,cL,cR){var sw=cv.width,sh=cv.height,x0=Math.round(sw*cL),x1=Math.round(sw*cR),nw=Math.max(10,x1-x0);var o=document.createElement('canvas');o.width=nw;o.height=sh;o.getContext('2d').drawImage(cv,x0,0,nw,sh,0,0,nw,sh);return o;}
function featherEdges(cv,ff){
  if(ff<=0)return cv;var nw=cv.width,sh=cv.height,o=document.createElement('canvas');o.width=nw;o.height=sh;
  var ctx=o.getContext('2d');ctx.drawImage(cv,0,0);var img=ctx.getImageData(0,0,nw,sh),d=img.data,mr=0,mg=0,mb=0,np=nw*sh;
  for(var i=0;i<np;i++){mr+=d[i*4];mg+=d[i*4+1];mb+=d[i*4+2];}mr/=np;mg/=np;mb/=np;
  var fp=Math.max(2,Math.round(nw*ff));
  for(var y=0;y<sh;y++){for(var x=0;x<fp;x++){var t=x/fp;t=t*t*(3-2*t);var idx=(y*nw+x)*4;d[idx]=Math.round(d[idx]*t+mr*(1-t));d[idx+1]=Math.round(d[idx+1]*t+mg*(1-t));d[idx+2]=Math.round(d[idx+2]*t+mb*(1-t));}for(var x=nw-fp;x<nw;x++){var t=(nw-1-x)/fp;t=t*t*(3-2*t);var idx=(y*nw+x)*4;d[idx]=Math.round(d[idx]*t+mr*(1-t));d[idx+1]=Math.round(d[idx+1]*t+mg*(1-t));d[idx+2]=Math.round(d[idx+2]*t+mb*(1-t));}}
  ctx.putImageData(img,0,0);return o;
}

function rebuildStripCache(){var tR=med(imgs.map(function(im){return hGeom(im.b).r;}));stripCache=imgs.map(function(im){var s=unwarp(im.cv,im.b,tR);compVig(s);return s;});}
function buildStrips(){if(stripCache.length!==imgs.length)rebuildStripCache();var ff=feather/100;return imgs.map(function(im,i){return featherEdges(cropStrip(stripCache[i],im.cropL,im.cropR),ff);});}

/* ═══ UPLOAD (Page 0) ═══ */
var fi=document.getElementById('fi');
fi.onchange=function(e){doFiles(e.target.files);};
function doFiles(fs){Array.from(fs).forEach(function(f){if(/\.json$/i.test(f.name)){loadSession(f);return;}var r=new FileReader();r.onload=function(e){loadSrc(e.target.result);};r.readAsDataURL(f);});}
function loadSrc(src){
  var im=new Image();im.onload=function(){
    var sc=Math.min(1,1200/im.width),c=document.createElement('canvas');
    c.width=Math.round(im.width*sc);c.height=Math.round(im.height*sc);
    c.getContext('2d').drawImage(im,0,0,c.width,c.height);
    var b=detectBounds(c);b.topH=initH(c,b,'top');b.botH=initH(c,b,'bot');
    imgs.push({cv:c,b:b,cropL:0.14,cropR:0.86});
    stripCache=[];renderUpload();
    document.getElementById('btnNext').disabled=imgs.length<2;
    document.getElementById('hint').textContent=(imgs.length>0&&imgs.length<2)?'Add at least 2 photos':'';
  };im.src=src;
}
function saveSession(){
  if(!imgs.length)return;
  var d={images:imgs.map(function(im){return{b:{cx:im.b.cx,r:im.b.r,yTop:im.b.yTop,yBot:im.b.yBot,xLeft:im.b.xLeft,xRight:im.b.xRight,topH:im.b.topH.map(function(h){var o={x:h.x,y:h.y};if(h.cp)o.cp={x:h.cp.x,y:h.cp.y};return o;}),botH:im.b.botH.map(function(h){var o={x:h.x,y:h.y};if(h.cp)o.cp={x:h.cp.x,y:h.cp.y};return o;})},cropL:im.cropL,cropR:im.cropR,img:im.cv.toDataURL('image/jpeg',.92)};})};
  var a=document.createElement('a');a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(d));a.download='vase_session.json';a.click();
}
function loadSession(file){
  var r=new FileReader();r.onload=function(e){try{var s=JSON.parse(e.target.result);imgs=[];var ent=s.images||s;var i=0;
  (function nx(){if(i>=ent.length){stripCache=[];renderUpload();document.getElementById('btnNext').disabled=imgs.length<2;return;}var en=ent[i++],im=new Image();im.onload=function(){var c=document.createElement('canvas');c.width=im.width;c.height=im.height;c.getContext('2d').drawImage(im,0,0);var b=en.b;b.topH=b.topH.map(function(h){var o={x:h.x,y:h.y};if(h.cp)o.cp={x:h.cp.x,y:h.cp.y};return o;});b.botH=b.botH.map(function(h){var o={x:h.x,y:h.y};if(h.cp)o.cp={x:h.cp.x,y:h.cp.y};return o;});
  if(!b.topH[0].cp||!b.topH[2].cp){var sp0=b.topH[2].x-b.topH[0].x;b.topH[0].cp={x:b.topH[0].x+sp0*0.25,y:b.topH[0].y};b.topH[2].cp={x:b.topH[2].x-sp0*0.25,y:b.topH[2].y};}
  if(!b.botH[0].cp||!b.botH[2].cp){var sp1=b.botH[2].x-b.botH[0].x;b.botH[0].cp={x:b.botH[0].x+sp1*0.25,y:b.botH[0].y};b.botH[2].cp={x:b.botH[2].x-sp1*0.25,y:b.botH[2].y};}
  imgs.push({cv:c,b:b,cropL:en.cropL!=null?en.cropL:0.14,cropR:en.cropR!=null?en.cropR:0.86});nx();};im.src=en.img;})();
  }catch(err){alert('Load failed: '+err.message);}};r.readAsText(file);
}
function renderUpload(){
  var el=document.getElementById('p0');el.innerHTML='<h1>Upload</h1>';
  var dz=document.createElement('div');dz.className='dropzone';dz.id='dz';
  dz.innerHTML='<div class="dz-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg></div><div class="dz-title">Drop photos or click to browse</div><div class="dz-sub">2+ overlapping shots · JPG, PNG, or .json session</div>';
  dz.onclick=function(){fi.click();};
  dz.ondragover=function(e){e.preventDefault();dz.classList.add('over');};
  dz.ondragleave=function(){dz.classList.remove('over');};
  dz.ondrop=function(e){e.preventDefault();dz.classList.remove('over');doFiles(e.dataTransfer.files);};
  el.appendChild(dz);
  if(imgs.length){
    var grid=document.createElement('div');grid.className='thumb-grid';
    imgs.forEach(function(im,i){var th=document.createElement('div');th.className='thumb';var img=document.createElement('img');img.src=im.cv.toDataURL('image/jpeg',.5);th.appendChild(img);th.innerHTML+='<div class="num">'+(i+1)+'</div><button class="rm" data-i="'+i+'">✕</button>';grid.appendChild(th);});
    el.appendChild(grid);
    grid.querySelectorAll('.rm').forEach(function(b){b.onclick=function(e){e.stopPropagation();imgs.splice(+this.dataset.i,1);stripCache=[];renderUpload();document.getElementById('btnNext').disabled=imgs.length<2;};});
    var ct=document.createElement('div');ct.className='count';ct.textContent=imgs.length+' photo'+(imgs.length>1?'s':'');el.appendChild(ct);
  }
}

/* ═══ MAP RIMS (Page 1) ═══ */
function renderMap(){
  var el=document.getElementById('p1');
  el.innerHTML='<div style="display:flex;justify-content:space-between;align-items:baseline"><h1>Map Rims</h1><div class="legend"><span><span class="legend-dot" style="background:#f97316"></span>Top</span><span><span class="legend-dot" style="background:#3b82f6"></span>Bottom</span></div></div>';
  var grid=document.createElement('div');grid.className='rim-grid';
  imgs.forEach(function(im,i){grid.appendChild(makeRimCard(im,i));});
  el.appendChild(grid);
}

function _clampCP(h,which,cv){var H=cv.height,x0=h[0].x,x2=h[2].x,mn=Math.min(x0,x2),mx2=Math.max(x0,x2),sp=mx2-mn,cp=(which===0)?h[0].cp:h[2].cp;if(!cp)return;var pad=Math.max(2,sp*0.02);cp.x=Math.max(mn+pad,Math.min(mx2-pad,cp.x));cp.y=Math.max(0,Math.min(H-1,cp.y));var ay=(which===0)?h[0].y:h[2].y,maxDy=Math.max(10,H*0.25);cp.y=Math.max(ay-maxDy,Math.min(ay+maxDy,cp.y));}

function makeRimCard(im,idx){
  var card=document.createElement('div');card.className='rim-card';
  var PW=280,sc=PW/im.cv.width,PH=Math.round(im.cv.height*sc);
  var cv=document.createElement('canvas');cv.width=PW;cv.height=PH;card.appendChild(cv);
  var prevLabel=document.createElement('div');prevLabel.style.cssText='padding:4px 10px 2px;font-size:10px;color:var(--t3);border-top:1px solid var(--border-lt)';prevLabel.textContent='Unwarp preview';card.appendChild(prevLabel);
  var prevCv=document.createElement('canvas');prevCv.style.cssText='display:block;width:100%;border-radius:0 0 var(--r) var(--r)';card.appendChild(prevCv);
  var foot=document.createElement('div');foot.className='rim-foot';
  foot.innerHTML='<span>'+(idx+1)+' · '+im.cv.width+'×'+im.cv.height+'</span>';
  var reBtn=document.createElement('button');reBtn.className='btn btn-ghost btn-icon';reBtn.style.fontSize='10px';reBtn.textContent='↺';reBtn.title='Reset rims';
  reBtn.onclick=function(){im.b.topH=initH(im.cv,im.b,'top');im.b.botH=initH(im.cv,im.b,'bot');stripCache=[];redraw(null);updatePreview();};
  var snapBtn=document.createElement('button');snapBtn.className='btn btn-outline btn-sm';snapBtn.textContent='Snap';snapBtn.style.marginLeft='6px';
  snapBtn.onclick=function(){try{snapRimToEdge(im,'top');snapRimToEdge(im,'bot');stripCache=[];redraw(null);updatePreview();}catch(e){console&&console.warn&&console.warn(e);}};
  foot.appendChild(reBtn);foot.appendChild(snapBtn);card.appendChild(foot);

  var b=im.b,ctx=cv.getContext('2d'),drag=null,prevDb=null;
  function updatePreview(){try{var g=hGeom(b),strip=unwarp(im.cv,b,g.r),psc=PW/strip.width,pH=Math.max(30,Math.round(strip.height*psc));prevCv.width=PW;prevCv.height=pH;prevCv.getContext('2d').drawImage(strip,0,0,PW,pH);}catch(e){}}
  function schedPrev(){if(prevDb)clearTimeout(prevDb);prevDb=setTimeout(updatePreview,80);}
  function cxy(e){var rect=cv.getBoundingClientRect(),sx=PW/rect.width,sy=PH/rect.height,ev=e.touches?e.touches[0]:e;return[(ev.clientX-rect.left)*sx,(ev.clientY-rect.top)*sy];}
  function hit(mx,my){
    var sets=[b.topH,b.botH];
    for(var si=0;si<2;si++){var hh=sets[si];if(hh[0].cp&&Math.hypot(mx-hh[0].cp.x*sc,my-hh[0].cp.y*sc)<=HR+2)return{h:hh,i:'cp0'};if(hh[2].cp&&Math.hypot(mx-hh[2].cp.x*sc,my-hh[2].cp.y*sc)<=HR+2)return{h:hh,i:'cp2'};}
    for(var si=0;si<2;si++)for(var i=0;i<3;i++){var h=sets[si][i];if(Math.hypot(mx-h.x*sc,my-h.y*sc)<=HR+3)return{h:sets[si],i:i};}return null;
  }
  function applyDrag(p){
    if(drag.i==='cp0'){drag.h[0].cp.x=p[0]/sc;drag.h[0].cp.y=p[1]/sc;_clampCP(drag.h,0,im.cv);}
    else if(drag.i==='cp2'){drag.h[2].cp.x=p[0]/sc;drag.h[2].cp.y=p[1]/sc;_clampCP(drag.h,2,im.cv);}
    else{drag.h[drag.i].x=p[0]/sc;drag.h[drag.i].y=p[1]/sc;}
    stripCache=[];redraw({mx:p[0],my:p[1],h:drag.h,hi:typeof drag.i==='number'?drag.i:drag.i==='cp0'?0:2});schedPrev();
  }
  cv.onmousedown=function(e){e.preventDefault();drag=hit.apply(null,cxy(e));};
  cv.onmousemove=function(e){e.preventDefault();var p=cxy(e);if(drag)applyDrag(p);else cv.style.cursor=hit(p[0],p[1])?'move':'default';};
  window.addEventListener('mouseup',function(){if(drag){drag=null;redraw(null);updatePreview();}});
  cv.addEventListener('touchstart',function(e){e.preventDefault();drag=hit.apply(null,cxy(e));},{passive:false});
  cv.addEventListener('touchmove',function(e){e.preventDefault();if(drag)applyDrag(cxy(e));},{passive:false});
  cv.addEventListener('touchend',function(){if(drag){drag=null;redraw(null);updatePreview();}});
  function redraw(li){ctx.drawImage(im.cv,0,0,PW,PH);drawOvl(ctx,b,sc);if(li)drawLoupe(ctx,im.cv,li,sc,PW,PH);}
  redraw(null);updatePreview();return card;
}

function drawOvl(ctx,b,sc){
  [[b.topH,'rgba(249,115,22,.95)'],[b.botH,'rgba(59,130,246,.95)']].forEach(function(pair){
    var h=pair[0],col=pair[1];
    var cp0=h[0].cp||{x:h[0].x+(h[1].x-h[0].x)*0.33,y:h[0].y};
    var cp2=h[2].cp||{x:h[2].x-(h[2].x-h[1].x)*0.33,y:h[2].y};
    ctx.strokeStyle=col;ctx.lineWidth=2;ctx.setLineDash([]);ctx.beginPath();
    for(var px=h[0].x;px<=h[2].x;px++){var py=evalRimCurve(h,px)*sc;px===h[0].x?ctx.moveTo(px*sc,py):ctx.lineTo(px*sc,py);}ctx.stroke();
    ctx.strokeStyle=col.replace('.95','.3');ctx.lineWidth=1;ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.moveTo(h[0].x*sc,h[0].y*sc);ctx.lineTo(cp0.x*sc,cp0.y*sc);ctx.stroke();
    ctx.beginPath();ctx.moveTo(h[2].x*sc,h[2].y*sc);ctx.lineTo(cp2.x*sc,cp2.y*sc);ctx.stroke();
    ctx.setLineDash([]);
    h.forEach(function(p,i){ctx.beginPath();ctx.arc(p.x*sc,p.y*sc,HR+0.5,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.3)';ctx.fill();ctx.beginPath();ctx.arc(p.x*sc,p.y*sc,HR,0,Math.PI*2);ctx.fillStyle=i===1?col:col.replace('.95','.6');ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.stroke();});
    [cp0,cp2].forEach(function(cp){ctx.beginPath();ctx.arc(cp.x*sc,cp.y*sc,HR-1,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.15)';ctx.fill();ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.stroke();});
  });
}
function drawLoupe(ctx,srcCv,info,sc,PW,PH){
  var hx=info.h[info.hi].x*sc,hy=info.h[info.hi].y*sc,lx=hx+LR+18,ly=hy-LR-18;
  if(lx+LR>PW)lx=hx-LR-18;if(ly-LR<0)ly=hy+LR+18;
  lx=Math.max(LR,Math.min(PW-LR,lx));ly=Math.max(LR,Math.min(PH-LR,ly));
  var sr=LR/LZOOM;ctx.save();ctx.beginPath();ctx.arc(lx,ly,LR,0,Math.PI*2);ctx.clip();
  ctx.drawImage(srcCv,info.h[info.hi].x-sr,info.h[info.hi].y-sr,sr*2,sr*2,lx-LR,ly-LR,LR*2,LR*2);
  ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(lx-8,ly);ctx.lineTo(lx+8,ly);ctx.moveTo(lx,ly-8);ctx.lineTo(lx,ly+8);ctx.stroke();
  ctx.restore();ctx.beginPath();ctx.arc(lx,ly,LR,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=2;ctx.stroke();
}

/* ═══ ADJUST STRIPS (Page 2) ═══ */
function renderAdjust(){
  var el=document.getElementById('p2');el.innerHTML='<h1>Adjust Strips</h1>';
  var card=document.createElement('div');card.className='card card-pad';
  var sr=document.createElement('div');sr.className='slider-row';sr.style.marginBottom='14px';
  sr.innerHTML='<label>Feather</label><input type="range" min="0" max="30" step="1" value="'+feather+'" id="fsl"><span class="val" id="fv">'+feather+'%</span>';
  card.appendChild(sr);
  var chk=document.createElement('div');chk.className='chk-row';chk.innerHTML='<input type="checkbox" id="cropToggle" checked><label for="cropToggle">HF smart crop</label>';card.appendChild(chk);
  var sep=document.createElement('div');sep.style.cssText='height:1px;background:var(--border-lt);margin:14px 0';card.appendChild(sep);
  if(stripCache.length!==imgs.length)rebuildStripCache();
  var scroll=document.createElement('div');scroll.className='strip-scroll';
  imgs.forEach(function(im,i){scroll.appendChild(makeCropCard(im,i));});
  card.appendChild(scroll);el.appendChild(card);
  var prevBtn=document.createElement('button');prevBtn.className='btn btn-outline';prevBtn.style.marginTop='12px';prevBtn.textContent='Preview';prevBtn.onclick=previewStrips;el.appendChild(prevBtn);
  var pw=document.createElement('div');pw.className='preview-bar';pw.id='prevWrap';pw.style.display='none';el.appendChild(pw);
  var meta=document.createElement('div');meta.className='meta';meta.id='prevMeta';el.appendChild(meta);
  setTimeout(function(){var fsl=document.getElementById('fsl');if(fsl)fsl.oninput=function(){feather=+this.value;document.getElementById('fv').textContent=feather+'%';};},0);
}
function makeCropCard(im,idx){
  var strip=stripCache[idx];if(!strip)return document.createElement('div');
  var card=document.createElement('div');card.className='strip-card';
  var PW=220,sc=PW/strip.width,PH=Math.max(40,Math.round(strip.height*sc));
  var cv=document.createElement('canvas');cv.width=PW;cv.height=PH;card.appendChild(cv);
  var foot=document.createElement('div');foot.className='strip-foot';
  var lbl=document.createElement('span');lbl.textContent=(idx+1)+' · '+Math.round(im.cropL*180)+'°–'+Math.round(im.cropR*180)+'°';foot.appendChild(lbl);
  var acts=document.createElement('div');acts.className='acts';
  var ml=document.createElement('button');ml.className='btn btn-ghost btn-icon btn-sm';ml.textContent='◀';ml.disabled=idx===0;
  ml.onclick=function(){if(idx>0){var t=imgs[idx];imgs[idx]=imgs[idx-1];imgs[idx-1]=t;var tc=stripCache[idx];stripCache[idx]=stripCache[idx-1];stripCache[idx-1]=tc;renderAdjust();}};
  var mr=document.createElement('button');mr.className='btn btn-ghost btn-icon btn-sm';mr.textContent='▶';mr.disabled=idx===imgs.length-1;
  mr.onclick=function(){if(idx<imgs.length-1){var t=imgs[idx];imgs[idx]=imgs[idx+1];imgs[idx+1]=t;var tc=stripCache[idx];stripCache[idx]=stripCache[idx+1];stripCache[idx+1]=tc;renderAdjust();}};
  var rm=document.createElement('button');rm.className='btn btn-ghost btn-icon btn-sm btn-danger';rm.textContent='✕';
  rm.onclick=function(){imgs.splice(idx,1);stripCache.splice(idx,1);renderAdjust();};
  acts.appendChild(ml);acts.appendChild(mr);acts.appendChild(rm);foot.appendChild(acts);card.appendChild(foot);
  var ctx=cv.getContext('2d'),dragging=null;
  function draw(){ctx.drawImage(strip,0,0,PW,PH);var lx=Math.round(im.cropL*PW),rx=Math.round(im.cropR*PW);ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(0,0,lx,PH);ctx.fillRect(rx,0,PW-rx,PH);ctx.fillStyle='rgba(249,115,22,.8)';ctx.fillRect(lx-1.5,0,3,PH);ctx.fillStyle='rgba(59,130,246,.8)';ctx.fillRect(rx-1.5,0,3,PH);}
  function evX(e){var rect=cv.getBoundingClientRect(),ev=e.touches?e.touches[0]:e;return(ev.clientX-rect.left)*(PW/rect.width);}
  function hitE(mx){var lx=im.cropL*PW,rx=im.cropR*PW;if(Math.abs(mx-lx)<12)return'L';if(Math.abs(mx-rx)<12)return'R';return null;}
  cv.onmousedown=function(e){e.preventDefault();dragging=hitE(evX(e));};
  cv.onmousemove=function(e){e.preventDefault();var mx=evX(e);if(dragging){var v=Math.max(0,Math.min(1,mx/PW));if(dragging==='L')im.cropL=Math.min(v,im.cropR-.05);else im.cropR=Math.max(v,im.cropL+.05);lbl.textContent=(idx+1)+' · '+Math.round(im.cropL*180)+'°–'+Math.round(im.cropR*180)+'°';draw();}else cv.style.cursor=hitE(mx)?'ew-resize':'default';};
  window.addEventListener('mouseup',function(){dragging=null;});
  cv.addEventListener('touchstart',function(e){e.preventDefault();dragging=hitE(evX(e));},{passive:false});
  cv.addEventListener('touchmove',function(e){e.preventDefault();var mx=evX(e);if(dragging){var v=Math.max(0,Math.min(1,mx/PW));if(dragging==='L')im.cropL=Math.min(v,im.cropR-.05);else im.cropR=Math.max(v,im.cropL+.05);lbl.textContent=(idx+1)+' · '+Math.round(im.cropL*180)+'°–'+Math.round(im.cropR*180)+'°';draw();}},{passive:false});
  cv.addEventListener('touchend',function(){dragging=null;});
  draw();return card;
}
function previewStrips(){
  if(!imgs.length)return;var strips=buildStrips(),gap=6,maxH=0;
  strips.forEach(function(s){if(s.height>maxH)maxH=s.height;});
  var totalW=strips.reduce(function(s,c){return s+c.width;},0)+gap*(strips.length-1);
  var wrap=document.getElementById('prevWrap');wrap.style.display='block';wrap.innerHTML='';
  var cv=document.createElement('canvas');cv.width=totalW;cv.height=maxH;
  var ctx=cv.getContext('2d');ctx.fillStyle='#f5f5f5';ctx.fillRect(0,0,totalW,maxH);
  var cx=0;for(var i=0;i<strips.length;i++){ctx.drawImage(strips[i],cx,Math.round((maxH-strips[i].height)/2));cx+=strips[i].width;if(i<strips.length-1){ctx.fillStyle='#e0e0e0';ctx.fillRect(cx,0,gap,maxH);cx+=gap;}}
  wrap.appendChild(cv);
  document.getElementById('prevMeta').textContent=strips.length+' strips · '+totalW+' × '+maxH+' px';
}

/* ═══ STITCH (Page 3) ═══ */
function cvToBlob(cv,q){return new Promise(function(r){cv.toBlob(function(b){r(b);},'image/jpeg',q||.92);});}
async function hfUpload(canvases){
  var boundary='----FB'+Date.now().toString(36),parts=[];
  for(var i=0;i<canvases.length;i++){var blob=await cvToBlob(canvases[i],.92),ab=await blob.arrayBuffer();parts.push(new TextEncoder().encode('--'+boundary+'\r\nContent-Disposition: form-data; name="files"; filename="strip_'+i+'.jpg"\r\nContent-Type: image/jpeg\r\n\r\n'));parts.push(new Uint8Array(ab));parts.push(new TextEncoder().encode('\r\n'));}
  parts.push(new TextEncoder().encode('--'+boundary+'--\r\n'));
  var tLen=0;for(var p=0;p<parts.length;p++)tLen+=parts[p].byteLength;
  var body=new Uint8Array(tLen),off=0;for(var p=0;p<parts.length;p++){body.set(parts[p],off);off+=parts[p].byteLength;}
  var opts={method:'POST',headers:{'Content-Type':'multipart/form-data; boundary='+boundary},body:body};
  if(stitchAbort)opts.signal=stitchAbort.signal;
  var resp=await fetch(HF+'/gradio_api/upload?upload_id='+Date.now().toString(36),opts);
  if(!resp.ok)throw new Error('Upload failed: '+resp.status);return await resp.json();
}
function mkIO(p){return{path:p,url:null,size:null,orig_name:'strip.jpg',mime_type:'image/jpeg',is_stream:false,meta:{}};}
async function hfCall(paths,doCrop){
  var data=[];for(var i=0;i<5;i++)data.push(i<paths.length?mkIO(paths[i]):null);data.push(!!doCrop);
  var resp=await fetch(HF+'/gradio_api/call/process_images',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:data}),signal:stitchAbort?stitchAbort.signal:undefined});
  if(!resp.ok)throw new Error('API submit failed: '+resp.status);
  var job=await resp.json();logMsg('Job: '+job.event_id);
  var sse=await fetch(HF+'/gradio_api/call/process_images/'+job.event_id,stitchAbort?{signal:stitchAbort.signal}:{});
  if(!sse.ok)throw new Error('SSE failed: '+sse.status);
  var rd=sse.body.getReader(),dc=new TextDecoder(),buf='';
  while(true){var ch=await rd.read();if(ch.done)break;buf+=dc.decode(ch.value,{stream:true});
    var cm=buf.match(/event:\s*complete\ndata:\s*(.+)/);if(cm){try{rd.cancel();}catch(e){}return JSON.parse(cm[1])[0];}
    var em=buf.match(/event:\s*error\ndata:\s*(.+)/);if(em){try{rd.cancel();}catch(e){}throw new Error('API: '+em[1].substring(0,200));}
    if(buf.includes('event: heartbeat'))logMsg('Processing…');}
  throw new Error('SSE ended without result');
}
async function loadResult(obj){
  var url=obj.url?(obj.url.startsWith('/')?HF+obj.url:obj.url):HF+'/gradio_api/file='+obj.path;
  var resp=await fetch(url);if(!resp.ok)throw new Error('Load failed: '+resp.status);
  var blob=await resp.blob(),u=URL.createObjectURL(blob);
  return new Promise(function(res,rej){var im=new Image();im.onload=function(){var cv=document.createElement('canvas');cv.width=im.width;cv.height=im.height;cv.getContext('2d').drawImage(im,0,0);URL.revokeObjectURL(u);res(cv);};im.onerror=function(){URL.revokeObjectURL(u);rej(new Error('Image load failed'));};im.src=u;});
}
async function stitchBatch(canvases){
  logMsg('Uploading '+canvases.length+' strips…');var paths=await hfUpload(canvases);logMsg('Calling Pixel Stitch…');
  var ct=document.getElementById('cropToggle'),doCrop=ct?ct.checked:true;
  var r=await hfCall(paths,doCrop);logMsg('✓ Batch done');return await loadResult(r);
}
var logEl=null;
function logMsg(m){if(logEl){logEl.style.display='block';logEl.textContent+=m+'\n';logEl.scrollTop=logEl.scrollHeight;}}
function setProgress(pct){var f=document.getElementById('pf');if(f)f.style.width=pct+'%';}
function setStepState(idx,state){var steps=document.querySelectorAll('#stitchSteps .p-step');if(steps[idx])steps[idx].className='p-step '+state;}

async function runStitch(){
  if(imgs.length<2)return;
  stitchRunning=true;stitchAbort=new AbortController();
  var el=document.getElementById('p3');
  el.innerHTML='<div class="card"><div class="stitch-center"><div class="spinner" id="sp"></div><div style="font-size:.95em;font-weight:500" id="stTitle">Stitching…</div><div class="pbar"><div class="pbar-fill" id="pf"></div></div><div class="p-steps" id="stitchSteps"><div class="p-step active"><div class="p-dot"></div>Building strips</div><div class="p-step"><div class="p-dot"></div>Uploading to server</div><div class="p-step"><div class="p-dot"></div>Running Pixel Stitch</div><div class="p-step"><div class="p-dot"></div>Downloading result</div></div><button class="btn btn-outline btn-sm" id="btnAbort" style="margin-top:16px">Cancel</button></div></div><div class="stitch-log" id="stitchLog"></div>';
  logEl=document.getElementById('stitchLog');
  document.getElementById('btnAbort').onclick=function(){if(stitchAbort){stitchAbort.abort();stitchAbort=null;}logMsg('Cancelled');document.getElementById('stTitle').textContent='Cancelled';document.getElementById('sp').style.display='none';this.disabled=true;stitchRunning=false;document.getElementById('btnBack').style.visibility='visible';};
  try{
    setStepState(0,'p-step active');setProgress(5);
    var strips=buildStrips(),N=strips.length;
    logMsg(N+' strips ('+strips[0].width+'×'+strips[0].height+'px)');
    setStepState(0,'p-step done');setStepState(1,'p-step active');setProgress(15);
    var result;
    if(N<=5){var b=strips.slice();while(b.length<3)b.push(b[b.length-1]);result=await stitchBatch(b);setProgress(70);
    }else{var fn=Math.min(5,N);result=await stitchBatch(strips.slice(0,fn));setProgress(30);var done=fn,bn=2;while(done<N){var tk=Math.min(N-done,4);if(tk<2)tk=2;var batch=[result];for(var i=0;i<tk;i++)batch.push(strips[(done+i)%N]);logMsg('Batch '+bn);result=await stitchBatch(batch);done+=tk;bn++;setProgress(30+Math.round(40*done/N));}}
    setStepState(1,'p-step done');setStepState(2,'p-step done');setStepState(3,'p-step active');setProgress(85);
    logMsg('Result: '+result.width+'×'+result.height+'px');
    setStepState(3,'p-step done');setProgress(100);
    document.getElementById('stTitle').textContent='Done';
    document.getElementById('sp').outerHTML='<div class="check-circle">✓</div>';
    rawHFCanvas=result;rCanvas=result;
    originalHFCanvas=result;
    topLine=[];botLine=[];leftLine=[];rightLine=[];
    stitchRunning=false;stitchAbort=null;
    setTimeout(function(){mx=4;go(4);},600);
  }catch(err){
    if(err.name==='AbortError')return;
    logMsg('✗ '+err.message);document.getElementById('stTitle').textContent='Failed';document.getElementById('sp').style.display='none';
    var ab=document.getElementById('btnAbort');if(ab)ab.disabled=true;
    stitchRunning=false;stitchAbort=null;document.getElementById('btnBack').style.visibility='visible';
  }
}

/* ═══════════════════════════════════════════════════════════════════
   REFINE (Page 4) — FIXED: polyline interp, H+V rectify, export
   ═══════════════════════════════════════════════════════════════════ */
var rcv,rctx;

/* Polyline interpolation — used by both H and V rectify */
function interpPolylineX(pts,x){
  if(pts.length<2)return pts.length?pts[0].y:0;
  if(x<=pts[0].x)return pts[0].y;if(x>=pts[pts.length-1].x)return pts[pts.length-1].y;
  for(var i=0;i<pts.length-1;i++){if(x>=pts[i].x&&x<=pts[i+1].x){var t=(x-pts[i].x)/(pts[i+1].x-pts[i].x);return pts[i].y*(1-t)+pts[i+1].y*t;}}
  return pts[pts.length-1].y;
}
function interpPolylineY(pts,y){
  if(pts.length<2)return pts.length?pts[0].x:0;
  // pts sorted by y for vertical lines
  var sorted=pts.slice().sort(function(a,b){return a.y-b.y;});
  if(y<=sorted[0].y)return sorted[0].x;if(y>=sorted[sorted.length-1].y)return sorted[sorted.length-1].x;
  for(var i=0;i<sorted.length-1;i++){if(y>=sorted[i].y&&y<=sorted[i+1].y){var t=(y-sorted[i].y)/(sorted[i+1].y-sorted[i].y);return sorted[i].x*(1-t)+sorted[i+1].x*t;}}
  return sorted[sorted.length-1].x;
}

function renderRefine(){
  var el=document.getElementById('p4');el.innerHTML='<h1>Refine</h1>';

  /* Straighten section */
  var sec=document.createElement('div');sec.className='section';
  sec.innerHTML='<div class="sec-head"><span class="sec-label">Straighten</span><span class="opt-badge">Optional</span></div>';
  var tb=document.createElement('div');tb.className='toolbar';
  tb.innerHTML='<button class="btn btn-dark btn-sm" id="tHoriz">Horizontal</button><button class="btn btn-outline btn-sm" id="tVert">Vertical</button><div style="flex:1"></div><button class="btn btn-outline btn-sm" id="tRevert">Revert</button><button class="btn btn-dark btn-sm" id="tApply" disabled>Rectify</button>';
  sec.appendChild(tb);
  var cw=document.createElement('div');cw.className='canvas-wrap';
  rcv=document.createElement('canvas');rcv.id='rectCanvas';rcv.style.cursor='crosshair';
  cw.appendChild(rcv);sec.appendChild(cw);el.appendChild(sec);
  rctx=rcv.getContext('2d');

  if(rawHFCanvas){
    var maxW=Math.min(1200,window.innerWidth-80);
    rectSc=Math.min(1,maxW/rawHFCanvas.width);
    rcv.width=Math.round(rawHFCanvas.width*rectSc);
    rcv.height=Math.round(rawHFCanvas.height*rectSc);
    if(!topLine.length){
      var pad=Math.round(rawHFCanvas.width*0.02);
      topLine=[{x:pad,y:Math.round(rawHFCanvas.height*0.15)},{x:rawHFCanvas.width-pad,y:Math.round(rawHFCanvas.height*0.15)}];
      botLine=[{x:pad,y:Math.round(rawHFCanvas.height*0.85)},{x:rawHFCanvas.width-pad,y:Math.round(rawHFCanvas.height*0.85)}];
    }
    if(!leftLine.length){
      var pad2=Math.round(rawHFCanvas.width*0.12);
      leftLine=[{x:pad2,y:Math.round(rawHFCanvas.height*0.10)},{x:pad2,y:Math.round(rawHFCanvas.height*0.90)}];
      rightLine=[{x:rawHFCanvas.width-pad2,y:Math.round(rawHFCanvas.height*0.10)},{x:rawHFCanvas.width-pad2,y:Math.round(rawHFCanvas.height*0.90)}];
    }
    drawRect();
  }

  /* Mode toggle */
  document.getElementById('tHoriz').onclick=function(){refineMode='h';activeLine='top';drawRect();};
  document.getElementById('tVert').onclick=function(){refineMode='v';activeLine='left';drawRect();};
  document.getElementById('tRevert').onclick=function(){
    if(!originalHFCanvas)return;
    rawHFCanvas=originalHFCanvas;rCanvas=originalHFCanvas;
    topLine=[];botLine=[];leftLine=[];rightLine=[];
    var W=rawHFCanvas.width,H=rawHFCanvas.height,pad=Math.round(W*0.02),pad2=Math.round(W*0.12);
    topLine=[{x:pad,y:Math.round(H*0.15)},{x:W-pad,y:Math.round(H*0.15)}];
    botLine=[{x:pad,y:Math.round(H*0.85)},{x:W-pad,y:Math.round(H*0.85)}];
    leftLine=[{x:pad2,y:Math.round(H*0.10)},{x:pad2,y:Math.round(H*0.90)}];
    rightLine=[{x:W-pad2,y:Math.round(H*0.10)},{x:W-pad2,y:Math.round(H*0.90)}];
    drawRect();
  };
  document.getElementById('tApply').onclick=doRectify;

  /* Canvas events */
  rcv.addEventListener('mousedown',onRectDown);
  rcv.addEventListener('mousemove',onRectMove);
  window.addEventListener('mouseup',function(){dragIdx=-1;});
  rcv.addEventListener('dblclick',onRectDbl);
  rcv.addEventListener('touchstart',onRectTouchStart,{passive:false});
  rcv.addEventListener('touchmove',onRectTouchMove,{passive:false});
  rcv.addEventListener('touchend',function(){dragIdx=-1;});

  /* Export row */
  var exp=document.createElement('div');exp.className='export-row';exp.style.marginTop='8px';
  var dl=document.createElement('button');dl.className='btn btn-dark';dl.textContent='Download PNG';
  dl.onclick=function(){if(!rCanvas)return;var a=document.createElement('a');a.href=rCanvas.toDataURL('image/png');a.download='vase_rollout.png';a.click();};
  var sv=document.createElement('button');sv.className='btn btn-outline';sv.textContent='Save Session';sv.onclick=saveSession;
  exp.appendChild(dl);exp.appendChild(sv);el.appendChild(exp);

  if(rawHFCanvas&&!rCanvas)rCanvas=rawHFCanvas;
}

function drawRect(){
  if(!rawHFCanvas||!rctx)return;
  rctx.drawImage(rawHFCanvas,0,0,rcv.width,rcv.height);
  rctx.fillStyle='rgba(0,0,0,0.08)';rctx.fillRect(0,0,rcv.width,rcv.height);

  var isH=(refineMode==='h');
  /* Update button styles */
  var bh=document.getElementById('tHoriz'),bv=document.getElementById('tVert');
  if(bh)bh.className=isH?'btn btn-dark btn-sm':'btn btn-outline btn-sm';
  if(bv)bv.className=isH?'btn btn-outline btn-sm':'btn btn-dark btn-sm';

  if(isH){
    drawPolyline(topLine,'rgba(249,115,22,.9)','rgba(249,115,22,.4)');
    drawPolyline(botLine,'rgba(59,130,246,.9)','rgba(59,130,246,.4)');
  }else{
    drawPolyline(leftLine,'rgba(249,115,22,.9)','rgba(249,115,22,.4)');
    drawPolyline(rightLine,'rgba(59,130,246,.9)','rgba(59,130,246,.4)');
  }

  var btn=document.getElementById('tApply');
  if(btn)btn.disabled=isH?!(topLine.length>=2&&botLine.length>=2):!(leftLine.length>=2&&rightLine.length>=2);
}

function drawPolyline(pts,col,fill){
  if(!pts.length)return;var sc=rectSc;
  if(pts.length>=2){rctx.strokeStyle=col;rctx.lineWidth=2;rctx.setLineDash([]);rctx.beginPath();rctx.moveTo(pts[0].x*sc,pts[0].y*sc);for(var i=1;i<pts.length;i++)rctx.lineTo(pts[i].x*sc,pts[i].y*sc);rctx.stroke();}
  pts.forEach(function(p){rctx.beginPath();rctx.arc(p.x*sc,p.y*sc,6,0,Math.PI*2);rctx.fillStyle=fill;rctx.fill();rctx.strokeStyle='#fff';rctx.lineWidth=1.5;rctx.stroke();});
}

function evXY(e){var rect=rcv.getBoundingClientRect(),ev=e.touches?e.touches[0]:e;return{x:(ev.clientX-rect.left)*(rcv.width/rect.width)/rectSc,y:(ev.clientY-rect.top)*(rcv.height/rect.height)/rectSc};}
function hitPt(pts,mx,my){var hr=12/rectSc;for(var i=0;i<pts.length;i++)if(Math.hypot(mx-pts[i].x,my-pts[i].y)<hr)return i;return-1;}
function hitSeg(pts,mx,my){if(pts.length<2)return pts.length;var best=-1,bestD=20/rectSc;for(var i=0;i<pts.length-1;i++){var ax=pts[i].x,ay=pts[i].y,bx=pts[i+1].x,by=pts[i+1].y,dx=bx-ax,dy=by-ay,len=Math.hypot(dx,dy);if(len<1)continue;var t=Math.max(0,Math.min(1,((mx-ax)*dx+(my-ay)*dy)/(len*len)));var d=Math.hypot(mx-(ax+t*dx),my-(ay+t*dy));if(d<bestD){bestD=d;best=i+1;}}return best;}
function addPtSorted(pts,p,sortByX){var np={x:Math.round(p.x),y:Math.round(p.y)};var seg=hitSeg(pts,p.x,p.y);if(seg>=0)pts.splice(seg,0,np);else pts.push(np);if(sortByX)pts.sort(function(a,b){return a.x-b.x;});else pts.sort(function(a,b){return a.y-b.y;});return pts.indexOf(np);}

/* Resolve which line (A or B) a click should target */
function resolveLineH(p){
  if(topLine.length<2||botLine.length<2)return activeLine;
  var ty=interpPolylineX(topLine,p.x),by=interpPolylineX(botLine,p.x);
  var dt=Math.abs(p.y-ty),db=Math.abs(p.y-by),span=Math.abs(by-ty);
  if(span<10)return activeLine;
  var ratio=dt/(dt+db);
  return ratio<0.35?'top':ratio>0.65?'bot':activeLine;
}
function resolveLineV(p){
  if(leftLine.length<2||rightLine.length<2){
    if(leftLine.length<2&&rightLine.length>=2)return'left';
    if(rightLine.length<2&&leftLine.length>=2)return'right';
    return activeLine;
  }
  var lx=interpPolylineY(leftLine,p.y),rx=interpPolylineY(rightLine,p.y);
  var dl=Math.abs(p.x-lx),dr=Math.abs(p.x-rx);
  return dl<dr?'left':'right';
}

function getActiveLines(){
  var isH=(refineMode==='h');
  var A=isH?topLine:leftLine,B=isH?botLine:rightLine;
  var aName=isH?'top':'left',bName=isH?'bot':'right';
  return{A:A,B:B,aName:aName,bName:bName,sortByX:isH};
}

function onRectDown(e){
  e.preventDefault();var p=evXY(e),g=getActiveLines();
  var hiA=hitPt(g.A,p.x,p.y),hiB=hitPt(g.B,p.x,p.y);
  if(hiA>=0){activeLine=g.aName;dragIdx=hiA;return;}
  if(hiB>=0){activeLine=g.bName;dragIdx=hiB;return;}
  var resolved=(refineMode==='h')?resolveLineH(p):resolveLineV(p);
  activeLine=resolved;
  var pts=(resolved===g.aName)?g.A:g.B;
  dragIdx=addPtSorted(pts,p,g.sortByX);
  drawRect();
}
function onRectMove(e){
  e.preventDefault();var p=evXY(e),g=getActiveLines();
  var pts=(activeLine===g.aName)?g.A:g.B;
  if(dragIdx>=0&&dragIdx<pts.length){
    pts[dragIdx].x=Math.max(0,Math.min(rawHFCanvas.width,Math.round(p.x)));
    pts[dragIdx].y=Math.max(0,Math.min(rawHFCanvas.height,Math.round(p.y)));
    drawRect();
  }else{
    var nearA=hitPt(g.A,p.x,p.y)>=0,nearB=hitPt(g.B,p.x,p.y)>=0;
    rcv.style.cursor=(nearA||nearB)?'grab':'crosshair';
  }
}
function onRectDbl(e){
  e.preventDefault();var p=evXY(e),g=getActiveLines();
  var hiA=hitPt(g.A,p.x,p.y),hiB=hitPt(g.B,p.x,p.y);
  if(hiA>=0&&g.A.length>2){g.A.splice(hiA,1);drawRect();return;}
  if(hiB>=0&&g.B.length>2){g.B.splice(hiB,1);drawRect();}
}
function onRectTouchStart(e){
  e.preventDefault();var p=evXY(e),g=getActiveLines();
  var hiA=hitPt(g.A,p.x,p.y),hiB=hitPt(g.B,p.x,p.y);
  if(hiA>=0){activeLine=g.aName;dragIdx=hiA;return;}
  if(hiB>=0){activeLine=g.bName;dragIdx=hiB;return;}
  var resolved=(refineMode==='h')?resolveLineH(p):resolveLineV(p);
  activeLine=resolved;
  var pts=(resolved===g.aName)?g.A:g.B;
  dragIdx=addPtSorted(pts,p,g.sortByX);drawRect();
}
function onRectTouchMove(e){
  e.preventDefault();if(dragIdx<0)return;var p=evXY(e),g=getActiveLines();
  var pts=(activeLine===g.aName)?g.A:g.B;
  if(dragIdx<pts.length){pts[dragIdx].x=Math.max(0,Math.min(rawHFCanvas.width,Math.round(p.x)));pts[dragIdx].y=Math.max(0,Math.min(rawHFCanvas.height,Math.round(p.y)));drawRect();}
}

/* ═══ RECTIFY ═══ */
function doRectify(){
  if(!rawHFCanvas)return;
  var W=rawHFCanvas.width,H=rawHFCanvas.height;
  var src=rawHFCanvas.getContext('2d').getImageData(0,0,W,H),sd=src.data;
  var out=document.createElement('canvas');out.width=W;out.height=H;
  var octx=out.getContext('2d'),dst=octx.createImageData(W,H),dd=dst.data;

  if(refineMode==='h'){
    if(topLine.length<2||botLine.length<2)return;
    /* Sample polylines to find median flat positions */
    var tS=[],bS=[];
    for(var x=0;x<W;x+=Math.max(1,Math.round(W/200))){tS.push(interpPolylineX(topLine,x));bS.push(interpPolylineX(botLine,x));}
    var flatTopY=med(tS),flatBotY=med(bS);
    for(var ox=0;ox<W;ox++){
      var curTop=interpPolylineX(topLine,ox),curBot=interpPolylineX(botLine,ox);
      var curSpan=Math.max(1,curBot-curTop),flatSpan=Math.max(1,flatBotY-flatTopY);
      for(var oy=0;oy<H;oy++){
        var srcY;
        if(oy<=flatTopY)srcY=oy+(curTop-flatTopY);
        else if(oy>=flatBotY)srcY=oy+(curBot-flatBotY);
        else{var t=(oy-flatTopY)/flatSpan;srcY=curTop+t*curSpan;}
        var sy0=srcY|0,sy1=sy0+1,fy=srcY-sy0;
        if(sy0<0){sy0=0;sy1=0;fy=0;}if(sy1>=H){sy1=H-1;sy0=sy1;fy=0;}
        var i0=(sy0*W+ox)*4,i1=(sy1*W+ox)*4,oi=(oy*W+ox)*4;
        dd[oi]=sd[i0]*(1-fy)+sd[i1]*fy;dd[oi+1]=sd[i0+1]*(1-fy)+sd[i1+1]*fy;dd[oi+2]=sd[i0+2]*(1-fy)+sd[i1+2]*fy;dd[oi+3]=255;
      }
    }
  }else{
    if(leftLine.length<2||rightLine.length<2)return;
    /* Vertical rectify: sample polylines, find median flat X positions */
    var lS=[],rS=[];
    for(var y=0;y<H;y+=Math.max(1,Math.round(H/200))){lS.push(interpPolylineY(leftLine,y));rS.push(interpPolylineY(rightLine,y));}
    var flatLeftX=med(lS),flatRightX=med(rS);
    for(var oy=0;oy<H;oy++){
      var curLeft=interpPolylineY(leftLine,oy),curRight=interpPolylineY(rightLine,oy);
      var curSpan=Math.max(1,curRight-curLeft),flatSpan=Math.max(1,flatRightX-flatLeftX);
      for(var ox=0;ox<W;ox++){
        var srcX;
        if(ox<=flatLeftX)srcX=ox+(curLeft-flatLeftX);
        else if(ox>=flatRightX)srcX=ox+(curRight-flatRightX);
        else{var t=(ox-flatLeftX)/flatSpan;srcX=curLeft+t*curSpan;}
        var sx0=srcX|0,sx1=sx0+1,fx=srcX-sx0;
        if(sx0<0){sx0=0;sx1=0;fx=0;}if(sx1>=W){sx1=W-1;sx0=sx1;fx=0;}
        var i0=(oy*W+sx0)*4,i1=(oy*W+sx1)*4,oi=(oy*W+ox)*4;
        dd[oi]=sd[i0]*(1-fx)+sd[i1]*fx;dd[oi+1]=sd[i0+1]*(1-fx)+sd[i1+1]*fx;dd[oi+2]=sd[i0+2]*(1-fx)+sd[i1+2]*fx;dd[oi+3]=255;
      }
    }
  }

  octx.putImageData(dst,0,0);
  rCanvas=out;
  rawHFCanvas=out;
  /* Reset lines for re-application */
  if(refineMode==='h'){
    topLine=[];botLine=[];
    var pad=Math.round(W*0.02);
    topLine=[{x:pad,y:Math.round(H*0.15)},{x:W-pad,y:Math.round(H*0.15)}];
    botLine=[{x:pad,y:Math.round(H*0.85)},{x:W-pad,y:Math.round(H*0.85)}];
  }else{
    leftLine=[];rightLine=[];
    var pad2=Math.round(W*0.12);
    leftLine=[{x:pad2,y:Math.round(H*0.10)},{x:pad2,y:Math.round(H*0.90)}];
    rightLine=[{x:W-pad2,y:Math.round(H*0.10)},{x:W-pad2,y:Math.round(H*0.90)}];
  }
  drawRect();
  var btn=document.getElementById('tApply');
  if(btn){btn.textContent='✓ Applied';btn.disabled=true;setTimeout(function(){btn.textContent='Rectify';btn.disabled=false;},1000);}
}

/* ═══ INIT ═══ */
renderStepper();
renderUpload();
</script>
</body>
</html>
